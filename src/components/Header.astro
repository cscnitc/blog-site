---
import Hr from "./Hr.astro";
import IconX from "@/assets/icons/IconX.svg";
import IconMoon from "@/assets/icons/IconMoon.svg";
import IconSearch from "@/assets/icons/IconSearch.svg";
import IconArchive from "@/assets/icons/IconArchive.svg";
import IconSunHigh from "@/assets/icons/IconSunHigh.svg";
import IconMenuDeep from "@/assets/icons/IconMenuDeep.svg";
import LinkButton from "./LinkButton.astro";
import { SITE } from "@/config";

const { pathname } = Astro.url;

// Remove trailing slash from current pathname if exists
const currentPath =
    pathname.endsWith("/") && pathname !== "/"
        ? pathname.slice(0, -1)
        : pathname;

const isActive = (path: string) => {
    const currentPathArray = currentPath.split("/").filter((p) => p.trim());
    const pathArray = path.split("/").filter((p) => p.trim());

    return currentPath === path || currentPathArray[0] === pathArray[0];
};
---

<header>
    <a
        id="skip-to-content"
        href="#main-content"
        class="absolute start-16 -top-full z-50 bg-background px-3 py-2 text-accent backdrop-blur-lg transition-all focus:top-4"
    >
        Skip to content
    </a>
    <div
        id="nav-container"
        class="mx-auto flex max-w-app flex-col items-center justify-between md:flex-row"
    >
        <div
            id="top-nav-wrap"
            class="flex w-full flex-col bg-background md:flex-row md:items-center"
        >
            <div
                class="flex w-full items-center justify-between p-4 gap-4 md:py-6"
            >
                <a
                    href="/"
                    class="shrink-0 overflow-x-auto py-1 text-xs leading-none font-bold hover:text-heading2 max-w-[60%] md:max-w-none"
                >
                    <!-- <pre class="text-[.5rem]">   
   _____  _____  _____   _   _ _____ _______ _____ 
  / ____|/ ____|/ ____| | \ | |_   _|__   __/ ____|
 | |    | (___ | |      |  \| | | |    | | | |     
 | |     \___ \| |      | . ` | | |    | | | |     
 | |____ ____) | |____  | |\  |_| |_   | | | |____ 
  \_____|_____/ \_____| |_| \_|_____|  |_|  \_____|
                                                   
                                                   </pre> -->
                    <pre
                        class="text-[0.35rem] md:text-[.5rem]">   
                                      ______  ______  ______
      //////// ////// /////  ///  // / ____/ / ____/ / ____/
     //////// ////// /////  ///  // / /     / /___  / /
    //////// ////// /////  ///  // / /     /__   / / /
   //////// ////// /////  ///  // / /___  ____/ / / /___
  //////// ////// /////  ///  //  \____/ /_____/  \____/
 //////// ////// /////  ///  //    CYBER SECURITY CLUB
                                                   </pre>
                </a>
                <button
                    id="menu-btn"
                    class="focus-outline shrink-0 p-2 md:hidden"
                    aria-label="Open Menu"
                    aria-expanded="false"
                    aria-controls="menu-items"
                >
                    <IconX id="close-icon" class="hidden" />
                    <IconMenuDeep id="menu-icon" />
                </button>
            </div>
            <nav
                id="nav-menu"
                class="w-full md:ms-2 md:flex md:flex-row md:justify-end md:space-x-2 md:py-0"
            >
                <ul
                    id="menu-items"
                    class:list={[
                        "mt-0 grid w-full grid-cols-2 place-content-center gap-2 pb-4 px-4",
                        "[&>li>a]:block [&>li>a]:px-1 lg:[&>li>a]:px-4  [&>li>a]:py-3 [&>li>a]:text-center [&>li>a]:font-medium [&>li>a]:hover:text-accent  md:[&>li>a]:py-1",
                        "hidden",
                        "md:mt-0 md:flex md:w-auto md:gap-x-1 lg:gap-x-5 md:gap-y-0 md:pb-0 md:px-0",
                    ]}
                >
                    <li class="col-span-2 md:text-nowrap">
                        <a
                            href="/posts"
                            class:list={{ "active-nav": isActive("/posts") }}
                        >
                            [ Posts ]
                        </a>
                    </li>
                    <li class="col-span-2 md:text-nowrap">
                        <a
                            href="/tags"
                            class:list={{ "active-nav": isActive("/tags") }}
                        >
                            [ Tags ]
                        </a>
                    </li>
                    <li class="col-span-2 md:text-nowrap">
                        <a
                            href="/events"
                            class:list={{ "active-nav": isActive("/events") }}
                        >
                            [ Events ]
                        </a>
                    </li>
                    <li class="col-span-2 md:text-nowrap">
                        <a
                            href="/team"
                            class:list={{ "active-nav": isActive("/team") }}
                        >
                            [ Team ]
                        </a>
                    </li>
                    <li class="col-span-2 md:text-nowrap">
                        <a
                            href="/sponsors"
                            class:list={{ "active-nav": isActive("/sponsors") }}
                        >
                            [ Sponsors ]
                        </a>
                    </li>
                    {
                        SITE.showArchives && (
                            <li class="col-span-2">
                                <LinkButton
                                    href="/archives"
                                    class:list={[
                                        "focus-outline flex justify-center p-3 md:p-1",
                                        {
                                            "active-nav [&>svg]:stroke-accent":
                                                isActive("/archives"),
                                        },
                                    ]}
                                    ariaLabel="archives"
                                    title="Archives"
                                >
                                    <IconArchive class="hidden md:inline-block" />
                                    <span class="md:sr-only">Archives</span>
                                </LinkButton>
                            </li>
                        )
                    }
                    <li class="col-span-2 flex items-center justify-center">
                        <LinkButton
                            href="/search"
                            class:list={[
                                "focus-outline flex p-3 md:p-1",
                                {
                                    "[&>svg]:stroke-accent":
                                        isActive("/search"),
                                },
                            ]}
                            ariaLabel="search"
                            title="Search"
                        >
                            <IconSearch />
                            <span class="sr-only">Search</span>
                        </LinkButton>
                    </li>
                    {
                        SITE.lightAndDarkMode && (
                            <li class="col-span-1 flex items-center justify-center">
                                <button
                                    id="theme-btn"
                                    class="focus-outline relative size-12 p-4 md:size-8 hover:[&>svg]:stroke-accent"
                                    title="Toggles light & dark"
                                    aria-label="auto"
                                    aria-live="polite"
                                >
                                    <IconMoon class="absolute top-[50%] left-[50%] -translate-[50%] scale-100 rotate-0 transition-all dark:scale-0 dark:-rotate-90" />
                                    <IconSunHigh class="absolute top-[50%] left-[50%] -translate-[50%] scale-0 rotate-90 transition-all dark:scale-100 dark:rotate-0" />
                                </button>
                            </li>
                        )
                    }
                </ul>
            </nav>
        </div>
    </div>
    <Hr />
</header>

<script>
    function toggleNav() {
        const menuBtn = document.querySelector("#menu-btn");
        const menuItems = document.querySelector("#menu-items");
        const menuIcon = document.querySelector("#menu-icon");
        const closeIcon = document.querySelector("#close-icon");

        if (!menuBtn || !menuItems || !menuIcon || !closeIcon) return;

        menuBtn.addEventListener("click", () => {
            const openMenu = menuBtn.getAttribute("aria-expanded") === "true";

            menuBtn.setAttribute("aria-expanded", openMenu ? "false" : "true");
            menuBtn.setAttribute(
                "aria-label",
                openMenu ? "Open Menu" : "Close Menu"
            );

            menuItems.classList.toggle("hidden");
            menuIcon.classList.toggle("hidden");
            closeIcon.classList.toggle("hidden");
        });
    }

    toggleNav();

    // Runs on view transitions navigation
    document.addEventListener("astro:after-swap", toggleNav);
</script>
