---
import type { GetStaticPaths } from "astro";
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Card from "@/components/Card.astro";
import Main from "@/layouts/Main.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import { slugifyStr } from "@/utils/slugify";
import { SITE } from "@/config";

export const getStaticPaths = (async () => {
  const blog = await getCollection("blog");
  const writeups = await getCollection("writeups");
  const all = [...blog, ...writeups];

  const authors = Array.from(new Set(all.map(p => p.data.author)));

  return authors.map(a => ({ params: { author: slugifyStr(a) } }));
}) satisfies GetStaticPaths;

const { params } = Astro.props as any;
const authorParam: string = (params && params.author) || (() => {
  try { return Astro.url?.pathname.split('/').filter(Boolean).pop() || "" } catch { return "" }
})();

const blog = await getCollection("blog", ({ data }) => !data.draft);
const writeups = await getCollection("writeups");
const all = [...blog, ...writeups];

const filtered = all.filter(p => slugifyStr(p.data.author || "") === authorParam);
const sorted = getSortedPosts(filtered as any);

const displayAuthor = filtered.length > 0 ? (filtered[0].data.author || authorParam) : authorParam;
---

<Layout title={`Author: ${displayAuthor} | ${SITE.title}`}>
  <Header />
  <Main pageTitle={`Author: ${displayAuthor}`} pageDesc={`Posts by ${displayAuthor}`}>
    {sorted.length === 0 ? (
      <p class="text-foreground/60">No posts by this author yet.</p>
    ) : (
      <ul>
        {sorted.map(post => <Card {...post} />)}
      </ul>
    )}
  </Main>
  <Footer />
</Layout>
